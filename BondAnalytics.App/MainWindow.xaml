<Window x:Class="BondAnalytics.App.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:conv="clr-namespace:BondAnalytics.App.Converters"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        Title="Bond Analytics" Height="600" Width="1191">

    <Window.Resources>

        <!-- Конвертер нумерации -->
        <conv:RowIndexConverter x:Key="RowIndexConverter"/>

        <!-- Группировка -->
        <CollectionViewSource x:Key="PortfolioView" Source="{Binding Portfolio}">
            <CollectionViewSource.GroupDescriptions>
                <PropertyGroupDescription PropertyName="Group"/>
            </CollectionViewSource.GroupDescriptions>
        </CollectionViewSource>

        <!-- Подсветка ячейки Профит -->
        <Style x:Key="ProfitCellStyle" TargetType="DataGridCell">
            <Setter Property="Foreground" Value="Black"/>
            <Style.Triggers>

                <!-- Убыток -->
                <DataTrigger Binding="{Binding IsProfitNegative}" Value="True">
                    <Setter Property="Background" Value="#FFFFC8C8"/>
                </DataTrigger>

                <!-- Прибыль -->
                <DataTrigger Binding="{Binding IsProfitPositive}" Value="True">
                    <Setter Property="Background" Value="#FFC8FFD1"/>
                </DataTrigger>

            </Style.Triggers>
        </Style>

    </Window.Resources>

    <DockPanel>

        <StackPanel Orientation="Horizontal" DockPanel.Dock="Top" Margin="5">
           
            <Button Content="Графики"
                Command="{Binding ShowChartsCommand}"
                Margin="7"/>


            <TextBlock Text="Фильтр:" VerticalAlignment="Center" Margin="10,0,5,0"/>

            <ComboBox Width="180"
                      ItemsSource="{Binding Filters}"
                      SelectedItem="{Binding SelectedFilter}"
                      Margin="5"/>
        </StackPanel>

        <StackPanel DockPanel.Dock="Bottom" Margin="10">
            <TextBlock Text="{Binding TotalPortfolioValue, StringFormat=Итого стоимость бумаг: {0:0.00}}"
                       FontSize="16"
                       FontWeight="Bold"/>

            <TextBlock Text="{Binding TotalNkd, StringFormat=Итого НКД: {0:0.00}}"
                       FontSize="16"
                       FontWeight="Bold"/>

            <TextBlock Text="{Binding TotalFullValue, StringFormat=Итого стоимость + НКД: {0:0.00}}"
                       FontSize="16"
                       FontWeight="Bold"/>
        </StackPanel>

        <DataGrid ItemsSource="{Binding Source={StaticResource PortfolioView}}"
          AutoGenerateColumns="False"
          CanUserSortColumns="True"
          IsReadOnly="True"
          Margin="5">

            <DataGrid.Columns>

                <DataGridTemplateColumn Header="№" Width="40" IsReadOnly="True">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock HorizontalAlignment="Center">
                                <TextBlock.Text>
                                    <MultiBinding Converter="{StaticResource RowIndexConverter}">
                                        <Binding RelativeSource="{RelativeSource AncestorType=DataGridRow}" />
                                        <Binding RelativeSource="{RelativeSource AncestorType=DataGrid}" />
                                    </MultiBinding>
                                </TextBlock.Text>
                            </TextBlock>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <DataGridTextColumn Header="Тикер"
                            Binding="{Binding Ticker}"
                            SortMemberPath="Ticker"/>

                <DataGridTextColumn Header="Название"
                            Binding="{Binding Name}"
                            SortMemberPath="Name"/>

                <DataGridTextColumn Header="Кол-во"
                            Binding="{Binding Quantity}"
                            SortMemberPath="Quantity"/>

                <DataGridTextColumn Header="Цена покупки"
                            Binding="{Binding AveragePrice, StringFormat={}{0:0.00}}"
                            SortMemberPath="AveragePrice"/>

                <DataGridTextColumn Header="Текущая цена"
                            Binding="{Binding CurrentPrice, StringFormat={}{0:0.00}}"
                            SortMemberPath="CurrentPrice"/>

                <DataGridTextColumn Header="Профит"
                            Binding="{Binding Profit, StringFormat={}{0:0.00}}"
                            SortMemberPath="Profit"
                            CellStyle="{StaticResource ProfitCellStyle}"/>

                <DataGridTextColumn Header="Полная стоимость"
                            Binding="{Binding TotalValue, StringFormat={}{0:0.00}}"
                            SortMemberPath="TotalValue"/>

                <DataGridTextColumn Header="НКД"
                            Binding="{Binding AccruedInterest, StringFormat={}{0:0.00}}"
                            SortMemberPath="AccruedInterest"/>

                <DataGridTextColumn Header="Номинал"
                            Binding="{Binding Nominal, StringFormat={}{0:0.00}}"
                            SortMemberPath="Nominal"/>

                <DataGridTextColumn Header="Купон"
                            Binding="{Binding Coupon, StringFormat={}{0:0.00}}"
                            SortMemberPath="Coupon"/>

                <DataGridTextColumn Header="Выплат/год"
                            Binding="{Binding CouponsPerYear}"
                            SortMemberPath="CouponsPerYear"/>

                <DataGridTextColumn Header="Ближайший купон"
                            Binding="{Binding NextCouponDate, StringFormat={}{0:dd.MM.yyyy}}"
                            SortMemberPath="NextCouponDate"/>

                <DataGridTextColumn Header="Купонная доходность"
                            Binding="{Binding CurrentYield, StringFormat={}{0:P2}}"
                            SortMemberPath="CurrentYield"/>


            </DataGrid.Columns>

        </DataGrid>


    </DockPanel>
</Window>
